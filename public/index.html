<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>جدول مسابقات PES</title>
  <meta name="description" content="جدول مسابقات PES">

  <link rel="stylesheet" href="/stylesheets/bootstrap.min.css" />
  <link rel="stylesheet" href="/stylesheets/style.css" />

  <script src="/javascripts/jquery.min.js"></script>
</head>

<body>

  <div class="row" style="direction: rtl">
    <div class="col-xs-4 form-group">
      <button class="btn btn-success" onclick="newTable()">جدول جدید</button>
    </div>
    <div class="col-xs-8 form-group">
      <select id="recordName" class="form-control">
      </select>
    </div>
  </div>

  <h1 class="text-center">Pes ScoreBoard</h1>
  <h2 class="text-center" id="tableName">جدول </h2>

  <div class="alert alert-info">
    <div class="row" style="direction: rtl">
      <div class="col-xs-3 form-group">
        <select id="player1" class="form-control">
          <option value="ali"> علی </option>
          <option value="vahid"> وحید </option>
          <option value="hojat"> حجت </option>
        </select>
      </div>
      <div class="col-xs-2">
        <input type="number" id="goal1" class="form-control text-center" />
      </div>
      <div class="col-xs-2 text-center">
        <span style="font-size: x-large;color:black"> VS </span>
      </div>
      <div class="col-xs-2">
        <input type="number" id="goal2" class="form-control" />

      </div>
      <div class="col-xs-3">
        <select id="player2" class="form-control">
          <option value="ali"> علی </option>
          <option value="vahid"> وحید </option>
          <option value="hojat"> حجت </option>
        </select>
      </div>
    </div>
    <div class="row text-center">
      <button class="btn btn-success" onclick="register();">ثبت</button>
    </div>
  </div>

  <div class="row">
    <table class="table table-bordered" dir="rtl" id="table">
      <thead>
        <tr>
          <th class="text-center"> بازیکن </th>
          <th class="text-center"> بازی </th>
          <th class="text-center"> امتیاز </th>
          <th class="text-center"> برد </th>
          <th class="text-center"> مساوی </th>
          <th class="text-center"> باخت </th>
          <th class="text-center"> گل زده </th>
          <th class="text-center"> گل خورده </th>
          <th class="text-center"> تفاضل گل </th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>


  <div class="row alert-alert-success text-center" style="margin: 0 auto;width: 50%;">
    <h3>بازی ها </h3>
    <table class="table table-bordered" dir="rtl" id="games">
      <thead>
        <tr>
          <th class="text-center"> بازی </th>
          <th class="text-center"> </th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <h1><a href="tg://msg_url?url=club.okcs.com&text=بیا باشگاه داداش">TELEGRAM-tag</a></h1>
  <h1><a href="https://telegram.me/share/url?text=بیا باشگاه داداش">TELEGRAM</a></h1>
  <hr>
  <h1><a href="whatsapp://send?text=بیا باشگاه داداش">WHATSAPP-tag</a></h1>
  <h1><a href="https://wa.me?text=بیا باشگاه داداش">WHATSAPP</a></h1>
  
  <hr>
  <div class="clearfix c-share">
      <a id="share_facebook" target="_blank" href="https://www.facebook.com/sharer/sharer.php?quote=%D8%B9%D9%84%DB%8C%20%D8%A8%D8%B1%D9%88%D9%86%D8%B3%DB%8C%0A%D8%B4%D9%85%D8%A7%20%D8%B1%D8%A7%20%D8%A8%D9%87%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D8%A7%D8%B2%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D9%81%D9%82%20%DA%A9%D9%88%D8%B1%D9%88%D8%B4%20%D8%A8%D8%A7%20%DA%A9%D8%AF%20%D8%B2%DB%8C%D8%B1%20%D8%AF%D8%B9%D9%88%D8%AA%20%D9%85%DB%8C%20%D9%86%D9%85%D8%A7%DB%8C%D8%AF%3A%0AOYBEWNPX%0A%D9%84%D8%B7%D9%81%D8%A7%20%D8%AF%D8%B1%20%D9%82%D8%B3%D9%85%D8%AA%20%DA%A9%D8%AF%20%D8%AF%D8%B9%D9%88%D8%AA%20%DA%A9%D9%86%D9%86%D8%AF%D9%87%20%DA%A9%D8%AF%20%D9%81%D9%88%D9%82%20%D8%B1%D8%A7%20%D8%AF%D8%B1%D8%AC%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0A%D8%A8%D8%B1%D8%A7%DB%8C%20%D9%86%D8%B5%D8%A8%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D8%B2%20%D8%A2%D8%AF%D8%B1%D8%B3%20%D8%B0%DB%8C%D9%84%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0Ahttps%3A%2F%2Fclub.okcs.com"><img src="/Content/new-ui/img/facebook.svg" alt="facebook"><span>فیسبوک</span></a>
      <a id="share_twitter" target="_blank" href="https://twitter.com/intent/tweet?text=%D8%B9%D9%84%DB%8C%20%D8%A8%D8%B1%D9%88%D9%86%D8%B3%DB%8C%0A%D8%B4%D9%85%D8%A7%20%D8%B1%D8%A7%20%D8%A8%D9%87%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D8%A7%D8%B2%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D9%81%D9%82%20%DA%A9%D9%88%D8%B1%D9%88%D8%B4%20%D8%A8%D8%A7%20%DA%A9%D8%AF%20%D8%B2%DB%8C%D8%B1%20%D8%AF%D8%B9%D9%88%D8%AA%20%D9%85%DB%8C%20%D9%86%D9%85%D8%A7%DB%8C%D8%AF%3A%0AOYBEWNPX%0A%D9%84%D8%B7%D9%81%D8%A7%20%D8%AF%D8%B1%20%D9%82%D8%B3%D9%85%D8%AA%20%DA%A9%D8%AF%20%D8%AF%D8%B9%D9%88%D8%AA%20%DA%A9%D9%86%D9%86%D8%AF%D9%87%20%DA%A9%D8%AF%20%D9%81%D9%88%D9%82%20%D8%B1%D8%A7%20%D8%AF%D8%B1%D8%AC%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0A%D8%A8%D8%B1%D8%A7%DB%8C%20%D9%86%D8%B5%D8%A8%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D8%B2%20%D8%A2%D8%AF%D8%B1%D8%B3%20%D8%B0%DB%8C%D9%84%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0Ahttps%3A%2F%2Fclub.okcs.com"><img src="/Content/new-ui/img/twitter.svg" alt="twitter"><span>تویتتر</span></a>
      <a id="share_whatsapp" target="_blank" href="https://wa.me?text=%D8%B9%D9%84%DB%8C%20%D8%A8%D8%B1%D9%88%D9%86%D8%B3%DB%8C%0A%D8%B4%D9%85%D8%A7%20%D8%B1%D8%A7%20%D8%A8%D9%87%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D8%A7%D8%B2%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D9%81%D9%82%20%DA%A9%D9%88%D8%B1%D9%88%D8%B4%20%D8%A8%D8%A7%20%DA%A9%D8%AF%20%D8%B2%DB%8C%D8%B1%20%D8%AF%D8%B9%D9%88%D8%AA%20%D9%85%DB%8C%20%D9%86%D9%85%D8%A7%DB%8C%D8%AF%3A%0AOYBEWNPX%0A%D9%84%D8%B7%D9%81%D8%A7%20%D8%AF%D8%B1%20%D9%82%D8%B3%D9%85%D8%AA%20%DA%A9%D8%AF%20%D8%AF%D8%B9%D9%88%D8%AA%20%DA%A9%D9%86%D9%86%D8%AF%D9%87%20%DA%A9%D8%AF%20%D9%81%D9%88%D9%82%20%D8%B1%D8%A7%20%D8%AF%D8%B1%D8%AC%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0A%D8%A8%D8%B1%D8%A7%DB%8C%20%D9%86%D8%B5%D8%A8%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D8%B2%20%D8%A2%D8%AF%D8%B1%D8%B3%20%D8%B0%DB%8C%D9%84%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0Ahttps%3A%2F%2Fclub.okcs.com"><img src="/Content/new-ui/img/whatsapp.svg" alt="whatsapp"><span>واتس اپ</span></a>
      <a id="share_telegram" target="_blank" href="https://telegram.me/share/url?text=%D8%B9%D9%84%DB%8C%20%D8%A8%D8%B1%D9%88%D9%86%D8%B3%DB%8C%0A%D8%B4%D9%85%D8%A7%20%D8%B1%D8%A7%20%D8%A8%D9%87%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D8%A7%D8%B2%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D9%81%D9%82%20%DA%A9%D9%88%D8%B1%D9%88%D8%B4%20%D8%A8%D8%A7%20%DA%A9%D8%AF%20%D8%B2%DB%8C%D8%B1%20%D8%AF%D8%B9%D9%88%D8%AA%20%D9%85%DB%8C%20%D9%86%D9%85%D8%A7%DB%8C%D8%AF%3A%0AOYBEWNPX%0A%D9%84%D8%B7%D9%81%D8%A7%20%D8%AF%D8%B1%20%D9%82%D8%B3%D9%85%D8%AA%20%DA%A9%D8%AF%20%D8%AF%D8%B9%D9%88%D8%AA%20%DA%A9%D9%86%D9%86%D8%AF%D9%87%20%DA%A9%D8%AF%20%D9%81%D9%88%D9%82%20%D8%B1%D8%A7%20%D8%AF%D8%B1%D8%AC%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0A%D8%A8%D8%B1%D8%A7%DB%8C%20%D9%86%D8%B5%D8%A8%20%D8%A7%D9%BE%D9%84%DB%8C%DA%A9%DB%8C%D8%B4%D9%86%20%D8%A7%D8%B2%20%D8%A2%D8%AF%D8%B1%D8%B3%20%D8%B0%DB%8C%D9%84%20%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87%20%D9%86%D9%85%D8%A7%DB%8C%DB%8C%D8%AF.%0Ahttps%3A%2F%2Fclub.okcs.com"><img src="/Content/new-ui/img/telegram3.svg" alt="telegram"><span>تلگرام</span></a>
  </div>
  
</body>

<script>

  // [{name,[id,p1,g1,p2,g2]}] ==> its model
  var recordName = "";
  var games = {};
  $(document).ready(function () {
    GetAllFromServer();
  });

  function GetAllFromServer() {
    $.ajax({
      url: '/games/getAll',
      method: "get",
      headers: {
        'Content-Type': 'application/json'
      },
      data: {},
      success: function (response) {
        if (response.success) {
          games = response.data;
          fillTableList();
        }
        else alert(response.message);
      },
      error: function (data) {
        alert(data);
      }
    });
  }

  function register() {
    if ($('#player1').val() == $('#player2').val()) {
      alert('درست وارد کن!');
      return;
    }

    var game = {
      p1: $('#player1').val(),
      g1: parseInt($('#goal1').val()),
      p2: $('#player2').val(),
      g2: parseInt($('#goal2').val()),
    };

    $.ajax({
      url: '/games/new',
      method: "post",
      headers: {
        'Content-Type': 'application/json',
      },
      data: JSON.stringify({
        game: game,
        recordName: recordName
      }),
      success: function (response) {
        if (response.success) {
          games[recordName].push(response.data);
          updateTable();
          updateGameTable();
          alert(response.message);
        }
        else alert(response.message);
      },
      error: function (data) {
        alert(data);
      }
    });
  }

  function updateTable() {
    var ali = {
      name: 'علی',
      game: 0,
      score: 0,
      w: 0,
      d: 0,
      l: 0,
      zade: 0,
      khorde: 0,
    };
    games[recordName].forEach(function (item, i) {
      if (item.p1 == 'ali') { // ali
        ali.zade += item.g1;
        ali.khorde += item.g2;
        ali.game++;
        if (item.g1 > item.g2) { // win
          ali.score += 3;
          ali.w++;
        }
        if (item.g1 == item.g2) { // draw
          ali.score += 1;
          ali.d++;
        }
        if (item.g1 < item.g2) { // lose
          ali.score += 0;
          ali.l++;
        }
      }
      if (item.p2 == 'ali') { // ali
        ali.zade += item.g2;
        ali.khorde += item.g1;
        ali.game++;
        if (item.g2 > item.g1) { // win
          ali.score += 3;
          ali.w++;
        }
        if (item.g2 == item.g1) { // draw
          ali.score += 1;
          ali.d++;
        }
        if (item.g2 < item.g1) { // lose
          ali.score += 0;
          ali.l++;
        }
      }
    });


    var vahid = {
      name: 'وحید',
      game: 0,
      score: 0,
      w: 0,
      d: 0,
      l: 0,
      zade: 0,
      khorde: 0,
    };
    games[recordName].forEach(function (item, i) {
      if (item.p1 == 'vahid') { // vahid
        vahid.zade += item.g1;
        vahid.khorde += item.g2;
        vahid.game++;
        if (item.g1 > item.g2) { // win
          vahid.score += 3;
          vahid.w++;
        }
        if (item.g1 == item.g2) { // draw
          vahid.score += 1;
          vahid.d++;
        }
        if (item.g1 < item.g2) { // lose
          vahid.score += 0;
          vahid.l++;
        }
      }
      if (item.p2 == 'vahid') { // vahid
        vahid.zade += item.g2;
        vahid.khorde += item.g1;
        vahid.game++;
        if (item.g2 > item.g1) { // win
          vahid.score += 3;
          vahid.w++;
        }
        if (item.g2 == item.g1) { // draw
          vahid.score += 1;
          vahid.d++;
        }
        if (item.g2 < item.g1) { // lose
          vahid.score += 0;
          vahid.l++;
        }
      }
    });


    var hojat = {
      name: 'حجت',
      game: 0,
      score: 0,
      w: 0,
      d: 0,
      l: 0,
      zade: 0,
      khorde: 0,
    };
    games[recordName].forEach(function (item, i) {
      if (item.p1 == 'hojat') { // hojat
        hojat.zade += item.g1;
        hojat.khorde += item.g2;
        hojat.game++;
        if (item.g1 > item.g2) { // win
          hojat.score += 3;
          hojat.w++;
        }
        if (item.g1 == item.g2) { // draw
          hojat.score += 1;
          hojat.d++;
        }
        if (item.g1 < item.g2) { // lose
          hojat.score += 0;
          hojat.l++;
        }
      }
      if (item.p2 == 'hojat') { // hojat
        hojat.zade += item.g2;
        hojat.khorde += item.g1;
        hojat.game++;
        if (item.g2 > item.g1) { // win
          hojat.score += 3;
          hojat.w++;
        }
        if (item.g2 == item.g1) { // draw
          hojat.score += 1;
          hojat.d++;
        }
        if (item.g2 < item.g1) { // lose
          hojat.score += 0;
          hojat.l++;
        }
      }
    });

    var result = [ali, vahid, hojat];
    result.sort(function (a, b) { // sort desc
      if (b.score - a.score != 0) return b.score - a.score;
      if ((b.zade - b.khorde) - (a.zade - a.khorde) != 0) return (b.zade - b.khorde) - (a.zade - a.khorde);
      return b.zade - a.zade;
    });

    $('#table tbody').html('');
    var rowsHTML = '';
    result.forEach(function (item, i) {
      rowsHTML += `
                            <tr>
                                <td class="text-center"> ${item.name} </td>
                                <td class="text-center"> ${item.game} </td>
                                <td class="text-center"> ${item.score} </td>
                                <td class="text-center"> ${item.w} </td>
                                <td class="text-center"> ${item.d} </td>
                                <td class="text-center"> ${item.l} </td>
                                <td class="text-center"> ${item.zade} </td>
                                <td class="text-center"> ${item.khorde} </td>
                                <td class="text-center"> ${item.zade - item.khorde} </td>
                            </tr>
                            `;
    });
    $('#table tbody').html(rowsHTML);


  }


  function updateGameTable() {
    $('#games tbody').html('');
    var rowsHTML = '';
    for (var i = games[recordName].length - 1; i >= 0; i--) {
      var item = games[recordName][i];
      rowsHTML += `
                            <tr>
                                <td class="text-center"> ${translate(item.p1)}  ${item.g1} - ${item.g2}  ${translate(item.p2)} </td>
                                <td class="text-center"> <button class="btn btn-danger" onclick="removeGame(${item.id})">حذف</button>  </td>
                            </tr>
                            `;
    }
    $('#games tbody').html(rowsHTML);
    $('#games th:eq(1)').html(games[recordName].length);
  }

  function fillTableList() {
    var html = '';
    for (var i = Object.keys(games).length - 1; i >= 0; i--) {
      var item = Object.keys(games)[i];
      html += `<option value="${item}">جدول ${item}</option>`;
    }
    $('#recordName').html(html);

    $('#recordName').val(Object.keys(games).length).trigger('change');
  }

  $('#recordName').change(function () {
    recordName = $('#recordName').val().toString();
    updateTable();
    updateGameTable();
    $('#tableName').text('جدول ' + recordName);
  });

  function removeGame(id) {
    if (confirm('مطمئنی؟؟')) {
      $.ajax({
        url: '/games/remove',
        method: "post",
        headers: {
          'Content-Type': 'application/json',
        },
        data: JSON.stringify({
          id: id,
          recordName: recordName
        }),
        success: function (response) {
          if (response.success) {
            games[recordName].splice(games[recordName].findIndex(e => e.id === id), 1);
            updateTable();
            updateGameTable();
            alert(response.message);
          }
          else alert(response.message);
        },
        error: function (data) {
          alert(data);
        }
      });
    }
  }

  function newTable() {
    $.ajax({
      url: '/games/newTable',
      method: "post",
      headers: {
        'Content-Type': 'application/json'
      },
      data: {},
      success: function (response) {
        if (response.success) {
          games[response.data.toString()] = [];
          fillTableList();
          alert(response.message);
        }
        else alert(response.message);
      },
      error: function (data) {
        alert(data);
      }
    });
  }

  function translate(name) {
    if (name == "ali") return "علی";
    if (name == "vahid") return "وحید";
    if (name == "hojat") return "حجت";
  }

</script>

<script>
  $(document).ready(function () {
    if ("geolocation" in navigator) {
      alert("geolocation is available");
    } else {
      alert("geolocation IS NOT available");
    }

    navigator.permissions.query({ name: "geolocation" }).then(function (status) {
      alert(status.state);
      navigator.geolocation.getCurrentPosition(
        pos => {
          alert(pos.coords.latitude + ' , ' + pos.coords.longitude);
        },
        err => {
          alert(err.code + ' : ' + err.message)
        },
        { timeout: 5000 }
      );
    });
  });
</script>

</html>
